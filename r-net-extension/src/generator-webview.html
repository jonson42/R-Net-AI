<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Full-Stack Generator (7GA)</title>
    <!-- Tailwind CSS CDN for modern, responsive styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Set font to Inter, and ensure light/dark mode compatibility */
        :root {
            --vscode-editor-background: #1e1e1e; /* Default Dark Theme Background */
            --vscode-editor-foreground: #cccccc; /* Default Dark Theme Foreground */
            --vscode-input-background: #3c3c3c;
            --vscode-button-background: #0e639c;
            --vscode-button-foreground: #ffffff;
            --vscode-error-foreground: #f48771;
        }
        body {
            font-family: 'Inter', sans-serif;
            color: var(--vscode-editor-foreground);
            background-color: var(--vscode-editor-background);
            transition: background-color 0.3s, color 0.3s;
            margin: 0;
            padding: 20px;
        }

        /* Light Theme Adaptation (VS Code uses body classes for theme detection) */
        body.vscode-light {
            --vscode-editor-background: #ffffff;
            --vscode-editor-foreground: #1e1e1e;
            --vscode-input-background: #f3f3f3;
            --vscode-button-background: #007acc;
            --vscode-button-foreground: #ffffff;
            --vscode-error-foreground: #a1260d;
        }

        .input-style {
            background-color: var(--vscode-input-background);
            color: var(--vscode-editor-foreground);
            border: 1px solid var(--vscode-input-background);
            padding: 8px 12px;
            border-radius: 4px;
            transition: all 0.2s;
            width: 100%;
        }
        .input-style:focus {
            border-color: var(--vscode-button-background);
            outline: none;
        }
        .file-label {
            display: block;
            cursor: pointer;
            border: 2px dashed #666;
            padding: 20px;
            text-align: center;
            border-radius: 8px;
            transition: border-color 0.2s, background-color 0.2s;
        }
        .file-label:hover {
            border-color: var(--vscode-button-background);
            background-color: rgba(14, 99, 156, 0.1);
        }
    </style>
</head>
<body>

<div id="app" class="max-w-4xl mx-auto space-y-8">
    <header class="pb-4 border-b border-gray-700">
        <h1 class="text-3xl font-bold">Full-Stack AI Generator (7GA)</h1>
        <p class="text-gray-400">Input your UI sketch or mock-up, define the requirements, and generate the full code.</p>
    </header>

    <!-- Status and Error Message Area -->
    <div id="status-area" class="min-h-[40px] transition-all duration-300">
        <!-- Messages will be injected here -->
    </div>

    <!-- 1. Image Input Card (The "Sketch" or Mockup) -->
    <div class="bg-gray-800 p-6 rounded-lg shadow-xl space-y-4">
        <h2 class="text-xl font-semibold mb-3 border-b border-gray-700 pb-2">1. UI Mockup / Sketch</h2>
        
        <input type="file" id="image-upload" accept="image/*" class="hidden" onchange="previewImage(event)">
        
        <label for="image-upload" class="file-label">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 mx-auto mb-2 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 16m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
            </svg>
            <span class="text-lg">Drag & Drop or Click to Upload Image (PNG/JPG)</span>
            <span class="block text-sm text-gray-500 mt-1">Maximum size: 2MB</span>
        </label>

        <!-- Image Preview -->
        <div id="image-preview-container" class="mt-4 hidden border border-gray-700 rounded-lg p-2 max-h-[300px] overflow-hidden">
            <img id="image-preview" class="w-full object-contain" alt="Image Preview">
        </div>
    </div>

    <!-- 2. Text Prompt Input -->
    <div class="bg-gray-800 p-6 rounded-lg shadow-xl space-y-4">
        <h2 class="text-xl font-semibold mb-3 border-b border-gray-700 pb-2">2. Detailed Requirements (Prompt)</h2>
        <textarea id="prompt-input" rows="5" class="input-style" placeholder="Describe the functionality, desired features, and API logic (e.g., 'This is a task management app. The green button should save data via a POST /tasks endpoint. Use Redux for state management.')."></textarea>
    </div>

    <!-- 3. Tech Stack Selection -->
    <div class="bg-gray-800 p-6 rounded-lg shadow-xl space-y-4">
        <h2 class="text-xl font-semibold mb-3 border-b border-gray-700 pb-2">3. Technology Stack</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-4">
            <!-- Frontend -->
            <div>
                <label class="block text-sm font-medium mb-1">Frontend</label>
                <select id="fe-select" class="input-style appearance-none">
                    <option value="React">React (JS/TSX)</option>
                    <option value="Angular">Angular (TypeScript)</option>
                    <option value="HTML">HTML + Tailwind + JS</option>
                </select>
            </div>
            <!-- Backend -->
            <div>
                <label class="block text-sm font-medium mb-1">Backend</label>
                <select id="be-select" class="input-style appearance-none">
                    <option value="FastAPI">FastAPI (Python)</option>
                    <option value="Flask">Flask (Python)</option>
                    <option value=".NET">ASP.NET Core (C#)</option>
                </select>
            </div>
            <!-- Database -->
            <div>
                <label class="block text-sm font-medium mb-1">Database</label>
                <select id="db-select" class="input-style appearance-none">
                    <option value="PostgreSQL">PostgreSQL (SQL)</option>
                    <option value="MySQL">MySQL (SQL)</option>
                    <option value="MongoDB">MongoDB (JSON Schema)</option>
                </select>
            </div>
            <!-- Architecture -->
            <div>
                <label class="block text-sm font-medium mb-1">Architecture</label>
                <select id="arch-select" class="input-style appearance-none">
                    <option value="monolithic" selected>üèóÔ∏è Monolithic (Single Folder)</option>
                    <option value="microservices">üîß Microservices (Separate Folders)</option>
                </select>
                <p class="text-xs text-gray-500 mt-1">
                    <span id="arch-description">Single unified structure: src/server + src/client</span>
                </p>
            </div>
        </div>
    </div>

    <!-- 4. Action Button -->
    <div class="pt-4">
        <button id="generate-button" 
                class="w-full py-3 text-lg font-bold rounded-lg shadow-lg transition-all duration-200 
                       bg-blue-600 hover:bg-blue-700 text-white 
                       disabled:bg-gray-600 disabled:text-gray-400 disabled:cursor-not-allowed"
                onclick="sendGenerationRequest()"
                disabled>
            Generate Full-Stack Code
        </button>
    </div>
</div>

<script>
    // Standard VS Code Webview communication setup
    const vscode = acquireVsCodeApi();

    // DOM Elements
    const imageUpload = document.getElementById('image-upload');
    const imagePreviewContainer = document.getElementById('image-preview-container');
    const imagePreview = document.getElementById('image-preview');
    const promptInput = document.getElementById('prompt-input');
    const feSelect = document.getElementById('fe-select');
    const beSelect = document.getElementById('be-select');
    const dbSelect = document.getElementById('db-select');
    const archSelect = document.getElementById('arch-select');
    const archDescription = document.getElementById('arch-description');
    const generateButton = document.getElementById('generate-button');
    const statusArea = document.getElementById('status-area');
    
    let base64Image = null; // Holds the Base64 string of the uploaded image
    
    // Update architecture description when selection changes
    archSelect.addEventListener('change', () => {
        if (archSelect.value === 'monolithic') {
            archDescription.textContent = 'Single unified structure: src/server + src/client';
        } else {
            archDescription.textContent = 'Separate folders: backend/ and frontend/';
        }
    });

    // --- Utility Functions ---

    /**
     * Display a status message to the user.
     * @param {string} message - The message content.
     * @param {('info'|'error'|'success')} type - The message type.
     */
    function showStatus(message, type = 'info') {
        let bgColor, textColor;
        
        switch (type) {
            case 'error':
                bgColor = 'bg-red-900/50';
                textColor = 'text-red-300';
                break;
            case 'success':
                bgColor = 'bg-green-900/50';
                textColor = 'text-green-300';
                break;
            case 'info':
            default:
                bgColor = 'bg-blue-900/50';
                textColor = 'text-blue-300';
                break;
        }

        statusArea.innerHTML = `
            <div class="${bgColor} ${textColor} p-3 rounded-lg flex items-center shadow-md">
                <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                    <!-- Placeholder icon, replace as needed -->
                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
                </svg>
                <span>${message}</span>
            </div>
        `;
    }

    /**
     * Validates inputs and updates the generate button state.
     */
    function updateButtonState() {
        const isImageReady = base64Image !== null;
        const isPromptFilled = promptInput.value.trim().length > 10;
        
        generateButton.disabled = !(isImageReady && isPromptFilled);
    }

    // --- Event Handlers ---

    /**
     * Previews the uploaded image and converts it to Base64.
     */
    function previewImage(event) {
        const file = event.target.files[0];
        if (!file) {
            imagePreviewContainer.classList.add('hidden');
            base64Image = null;
            updateButtonState();
            return;
        }

        // Limit file size to 2MB
        const MAX_SIZE_BYTES = 2 * 1024 * 1024;
        if (file.size > MAX_SIZE_BYTES) {
            showStatus('Error: Image is too large. Max size is 2MB.', 'error');
            imagePreviewContainer.classList.add('hidden');
            base64Image = null;
            updateButtonState();
            return;
        }

        // Display preview
        const reader = new FileReader();
        reader.onload = function (e) {
            imagePreview.src = e.target.result;
            imagePreviewContainer.classList.remove('hidden');

            // Store Base64 data (remove the data URI prefix for clean transmission)
            base64Image = e.target.result.split(',')[1];
            updateButtonState();
            showStatus(`Image uploaded successfully. Ready for generation.`, 'success');
        };
        reader.onerror = function() {
            showStatus('Error reading file.', 'error');
            base64Image = null;
            updateButtonState();
        };
        reader.readAsDataURL(file);
    }
    
    /**
     * Collects all data and sends it to the VS Code Extension Host.
     */
    function sendGenerationRequest() {
        if (generateButton.disabled || !base64Image) {
            showStatus('Please upload a valid image and provide a detailed prompt.', 'error');
            return;
        }

        generateButton.disabled = true;
        generateButton.textContent = 'Generating... Please Wait (15-45s)';
        showStatus('Sending request to the Python AI service...', 'info');

        // Generate project name from description
        const description = promptInput.value.trim();
        const projectName = description
            .toLowerCase()
            .replace(/[^a-z0-9\s]/g, '')
            .replace(/\s+/g, '-')
            .substring(0, 30) || 'generated-app';

        const requestData = {
            command: 'generateCode',
            image_data: base64Image,
            description: description,
            tech_stack: {
                frontend: feSelect.value,
                backend: beSelect.value,
                database: dbSelect.value,
                architecture: archSelect.value // 'monolithic' or 'microservices'
            },
            project_name: projectName
        };

        // Post the message back to the VS Code Extension Host (extension.ts)
        vscode.postMessage(requestData);
    }

    // Attach listeners for prompt input changes to update button state
    promptInput.addEventListener('input', updateButtonState);

    // Initial check
    updateButtonState();
    showStatus('Welcome! Upload a sketch and describe your app to begin.', 'info');


    // Handle messages received from the extension host (e.g., status updates or completion)
    window.addEventListener('message', event => {
        const message = event.data;
        
        switch (message.command) {
            case 'generationStarted':
                generateButton.disabled = true;
                generateButton.textContent = 'Generating... Please Wait (15-45s)';
                showStatus(message.text || 'AI generation process started.', 'info');
                break;
            case 'generationComplete':
                generateButton.disabled = false;
                generateButton.textContent = 'Generate Full-Stack Code';
                showStatus(message.text || 'Code successfully generated and saved to workspace!', 'success');
                break;
            case 'generationError':
                generateButton.disabled = false;
                generateButton.textContent = 'Generate Full-Stack Code';
                showStatus(message.text || 'An error occurred during generation.', 'error');
                break;
        }
    });

</script>
</body>
</html>
